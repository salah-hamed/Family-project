<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„ÙƒÙˆØ±Ø³ - Family Business</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 24px; flex-direction: column; gap: 10px; }
    .loading.hidden { display: none; }
    .error-msg { background: #ff4444; color: white; padding: 20px; border-radius: 10px; margin: 20px; text-align: center; }
    .course-header { text-align: center; color: white; margin-bottom: 40px; animation: fadeIn 1s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .progress-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; margin: 20px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s; border-radius: 5px; }
    .lesson { background: white; margin: 20px 0; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideIn 0.5s ease-out; display: none; }
    .lesson.active { display: block; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
    .lesson h2 { color: #667eea; margin-bottom: 15px; font-size: 24px; }
    .lesson-content { line-height: 1.8; margin-bottom: 20px; }
    .lesson-code { background: #f4f4f4; padding: 20px; border-radius: 10px; font-family: monospace; white-space: pre-wrap; overflow-x: auto; direction: ltr; text-align: left; margin-top: 15px; }
    .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
    .btn { padding: 12px 30px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; transition: all 0.3s; flex: 1; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .certificate-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; margin: 40px auto 20px; padding: 15px 40px; font-size: 20px; border-radius: 50px; display: block; }
    @media (max-width: 768px) { 
      .container { padding: 10px; } 
      .lesson { padding: 20px; } 
      .nav-buttons { flex-direction: column; } 
      .btn { padding: 15px; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒÙˆØ±Ø³... 
    <div id="loadingStatus">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
  </div>
  
  <div id="courseContent" class="container" style="display: none;">
    <div class="course-header">
      <h1>ğŸ“ ÙƒÙˆØ±Ø³ Family Business ÙƒØ§Ù…Ù„</h1>
      <p>Ø¨Ù†Ø§Ø¡ Ù…ÙˆÙ‚Ø¹ e-commerce ÙƒØ§Ù…Ù„ Ø¨Ù€ Firebase ÙÙŠ Ø³Ø§Ø¹Ø§Øª - Copy-Paste Method</p>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      <p id="progressText">Ø§Ù„Ø¯Ø±Ø³ 1 Ù…Ù† 10</p>
    </div>
    
    <div id="lessons"></div>
    
    <div class="nav-buttons">
      <button id="prevBtn" class="btn btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="nextBtn" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
    
    <button id="certificateBtn" class="certificate-btn" style="display: none;">ğŸ“œ Ø­Ù…Ù„ Ø´Ù‡Ø§Ø¯ØªÙƒ Ø§Ù„Ø¢Ù†!</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB...YOUR_API_KEY...", 
      authDomain: "kidsup-e998d.firebaseapp.com",
      projectId: "kidsup-e998d",
      storageBucket: "kidsup-e998d.appspot.com",
      messagingSenderId: "959800471628",
      appId: "1:959800471628:web:YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentLesson = 0;
    let currentUser = null;
    const totalLessons = 10;

    const lessons = [
      { title: "Ø§Ù„Ø¯Ø±Ø³ 1: Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Console", content: "1. Ø±ÙˆØ­ Firebase ConsoleØŒ Ø£Ù†Ø´Ø¦ project Ø¬Ø¯ÙŠØ¯ FamilyBusiness. 2. ÙØ¹Ù‘Ù„ Auth + Firestore. 3. Copy config ÙˆÙ„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.", code: "firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 2: ØµÙØ­Ø© Login Ø¨Ù€ Auth", content: "Ø§Ø³ØªØ®Ø¯Ù… email/password auth Ù…Ø¹ RTL design. Ø£Ù†Ø´Ø¦ ØµÙØ­Ø© login.html Ù…Ø¹ form ÙƒØ§Ù…Ù„.", code: "firebase.auth().createUserWithEmailAndPassword(email, password)
  .then((userCredential) => {
    console.log('ØªØ³Ø¬ÙŠÙ„ Ù†Ø§Ø¬Ø­');
  })
  .catch((error) => {
    console.log(error.message);
  });" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 3: Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore", content: "ØµÙ…Ù… collections: users, products, orders, merchants.", code: "db.collection('products').add({
  name: 'Ù…Ù†ØªØ¬1',
  price: 100,
  image: 'url',
  merchantId: 'merchant123'
});" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 4: ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", content: "Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Firestore Ù…Ø¹ search Ùˆ filters.", code: "db.collection('products').get().then(snapshot => {
  snapshot.forEach(doc => {
    console.log(doc.data());
  });
});" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 5: Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", content: "Ø£Ø¶Ù/remove Ù…Ù† Ø§Ù„Ø³Ù„Ø© Ù…Ø¹ localStorage backup.", code: "let cartItems = [];
cartItems.push(product);
localStorage.setItem('cart', JSON.stringify(cartItems));" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 6: Checkout + Payments", content: "Ø§Ø³ØªØ®Ø¯Ù… Fawry Ø£Ùˆ Paymob Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ù„ÙŠ.", code: "window.paymob = { /* config */ };" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 7: Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¬Ø±", content: "Dashboard Ù„Ù„ØªØ§Ø¬Ø± ÙŠØ¶ÙŠÙ/ÙŠØ¹Ø¯Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.", code: "if (user.role === 'merchant') {
  loadMerchantProducts();
}" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 8: ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Real-time", content: "Ø§Ø³ØªØ®Ø¯Ù… Firestore listeners Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©.", code: "db.collection('orders').where('status', '==', 'pending')
  .onSnapshot(snapshot => {
    updateOrdersUI(snapshot);
  });" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 9: Admin Panel", content: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª.", code: "rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}" },
      { title: "Ø§Ù„Ø¯Ø±Ø³ 10: Deployment + Monetization", content: "Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase Hosting + Ø¥Ø¹Ø¯Ø§Ø¯ Stripe subscriptions.", code: "firebase deploy;" }
    ];

    window.onload = async () => {
      const loading = document.getElementById('loading');
      const status = document.getElementById('loadingStatus');
      
      status.textContent = 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
      
      auth.onAuthStateChanged(async (user) => {
        console.log('Auth state changed:', user ? user.uid : 'No user');
        
        if (!user) {
          status.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„';
          setTimeout(() => {
            alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† login.html');
            window.location.href = 'login.html';
          }, 1500);
          return;
        }

        currentUser = user;
        status.textContent = 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...';
        
        try {
          console.log('Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© document:', user.uid);
          const doc = await db.collection('users').doc(user.uid).get();
          
          console.log('Document exists:', doc.exists);
          console.log('Document data:', doc.data());
          
          if (doc.exists) {
            const userData = doc.data();
            if (userData.courseActive) {
              currentLesson = userData.currentLesson || 0;
              loading.classList.add('hidden');
              document.getElementById('courseContent').style.display = 'block';
              initCourse();
              return;
            } else {
              throw new Error('courseActive = false');
            }
          } else {
            // Ø¥Ù†Ø´Ø§Ø¡ document Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            await db.collection('users').doc(user.uid).set({
              email: user.email,
              courseActive: false, // ØºÙŠØ± Ù…ÙØ¹Ù„ Ø­ØªÙ‰ Ø§Ù„Ø¯ÙØ¹
              currentLesson: 0,
              enrolledDate: firebase.firestore.FieldValue.serverTimestamp()
            });
            throw new Error('Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙØ¹Ù„. Ø£Ø¶Ù courseActive: true ÙÙŠ Firestore');
          }
        } catch (error) {
          console.error('Firestore error details:', error);
          
          // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
          if (error.code === 'permission-denied') {
            showError(`Ø®Ø·Ø£ ØµÙ„Ø§Ø­ÙŠØ§Øª: ${error.message}

ğŸ”§ Ø§Ù„Ø­Ù„:
1. Firebase Console â†’ Firestore â†’ Rules
2. Ø§Ù„ØµÙ‚ Ø§Ù„Ù€ rules Ø£Ø¹Ù„Ø§Ù‡
3. Ø§Ø¶ØºØ· Publish`);
          } else if (error.message.includes('courseActive')) {
            showError(`Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙØ¹Ù„ Ù„Ùƒ

ğŸ”§ Ø§Ù„Ø­Ù„:
1. Firebase Console â†’ Firestore â†’ users/${user.uid}
2. Ø£Ø¶Ù courseActive: true`);
          } else {
            showError(`Ø®Ø·Ø£: ${error.message}
Console: F12 â†’ Console Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„`);
          }
        }
      });
    };

    function showError(message) {
      const loading = document.getElementById('loading');
      loading.innerHTML = `<div class="error-msg">${message}</div>`;
    }

    function initCourse() {
      loadLessons();
      updateProgress();
      setupNavigation();
      setupCertificate();
    }

    function loadLessons() {
      const lessonsDiv = document.getElementById('lessons');
      lessonsDiv.innerHTML = '';
      
      lessons.forEach((lesson, index) => {
        const div = document.createElement('div');
        div.className = `lesson ${index === currentLesson ? 'active' : ''}`;
        div.innerHTML = `
          <h2>${lesson.title}</h2>
          <div class="lesson-content">${lesson.content}</div>
          ${lesson.code ? `<div class="lesson-code">${lesson.code}</div>` : ''}
        `;
        lessonsDiv.appendChild(div);
      });
    }

    function updateProgress() {
      const progress = ((currentLesson + 1) / totalLessons) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressText').textContent = `Ø§Ù„Ø¯Ø±Ø³ ${currentLesson + 1} Ù…Ù† ${totalLessons}`;
      
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({ 
          currentLesson: currentLesson
        }).catch(console.error);
      }
    }

    function setupNavigation() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.onclick = () => {
        if (currentLesson > 0) {
          document.querySelector('.lesson.active').classList.remove('active');
          currentLesson--;
          document.querySelectorAll('.lesson')[currentLesson].classList.add('active');
          updateProgress();
          updateButtonStates();
        }
      };

      nextBtn.onclick = () => {
        if (currentLesson < totalLessons - 1) {
          document.querySelector('.lesson.active').classList.remove('active');
          currentLesson++;
          document.querySelectorAll('.lesson')[currentLesson].classList.add('active');
          updateProgress();
          updateButtonStates();
        }
      };

      const updateButtonStates = () => {
        prevBtn.disabled = currentLesson === 0;
        nextBtn.disabled = currentLesson === totalLessons - 1;
        document.getElementById('certificateBtn').style.display = currentLesson + 1 === totalLessons ? 'block' : 'none';
      };
      updateButtonStates();
    }

    function setupCertificate() {
      document.getElementById('certificateBtn').onclick = async () => {
        try {
          const pdf = new jsPDF('p', 'mm', 'a4');
          pdf.setFontSize(20);
          pdf.text('Ø´Ù‡Ø§Ø¯Ø© Ø¥ÙƒÙ…Ø§Ù„ ÙƒÙˆØ±Ø³ Family Business', 105, 30, { align: 'center' });
          pdf.setFontSize(14);
          pdf.text(`Ø§Ù„Ø§Ø³Ù…: ${currentUser.email}`, 105, 50, { align: 'center' });
          pdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}`, 105, 60, { align: 'center' });
          
          const headerCanvas = await html2canvas(document.querySelector('.course-header'));
          const imgData = headerCanvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 20, 80, 170, 80);
          
          pdf.save(`Ø´Ù‡Ø§Ø¯Ø©-FamilyBusiness-${currentUser.uid.slice(0,8)}.pdf`);
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©! ğŸ‰');
        } catch (error) {
          console.error('Certificate error:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©');
        }
      };
    }
  </script>
</body>
</html>
